"use strict";define(["common/slider/slider","site/pages/pages","site/popups/popups","site/panels/panels"],function(e,t,o,i){function s(e,n,t){var o;2===e.loaded&&"function"==typeof e.ondestory&&e.ondestory(),$("#"+t).remove(),e.css&&"string"!=typeof e.css&&($(e.css).remove(),"stylesheet/less"===e.css.type&&(less.sheets.splice(less.sheets.indexOf(e.css),1),less.refresh()),e.css=e.css.getAttribute("href").replace(RegExp("^"+require.toUrl(n+"/"+t)+"/"),"")),e.js&&(o=n+"/"+t+"/"+e.js,require.defined(o)&&require([o],function(n){require.undef(o),n&&(e.__proto__=Object.prototype)})),e.loaded=0}function c(e,n,t,o){function i(){var i;"js"in n?(l.showLoading(),i=u+n.js,require([i],function(e){e&&(n.__proto__=e),n.loaded=2,o(),l.hideLoading()},require.data.debug?undefined:function(o){s(n,e,t),o.requireType&&"scripterror"!==o.requireType&&"nodefine"!==o.requireType||o.xhr&&404!==o.xhr.status?a(i,o.message,f):d(f),l.hideLoading()})):(n.loaded=2,o())}if(2===n.loaded)o();else if(1!==n.loaded){n.loaded=1;var c,r="#"+e+"s",u=e+"/"+t+"/",p=require.toUrl(u),f="page"===e;"popup"===e?r+=">div>div":"panel"===e&&(r+=">.contents>div"),r=$(r)[0],"string"==typeof n.css&&(n.css=l.appendCss(p+n.css)),"html"in n?(c=p+n.html,$.ajax({url:c,type:"get",dataType:"text",success:function(e){r.insertAdjacentHTML("afterBegin",'<div id="'+t+'">'+e+"</div>"),i()},error:function(o){s(n,e,t),require.data.debug||404!==o.status?a(c,o.status,f):d(f)},complete:l.hideLoading}),l.showLoading()):(r.insertAdjacentHTML("afterBegin",'<div id="'+t+'"></div>'),i())}}function a(e,n,t){l.alert("加载"+e+"时发生了一个错误: "+n,t?function(){history.back()}:undefined)}function d(e){e?location.reload():l.confirm("网站已经更新, 使用该功能需要先重新加载. 是否立即刷新本页?",function(e){e&&location.reload()})}var r,l={appendCss:function(e){var n=document.createElement("link");return n.type="text/css",/\.less$/.test(e)?"object"==typeof less?(n.rel="stylesheet/less",n.href=e,less.sheets.push(n),less.refresh()):(n.rel="stylesheet",n.href=e.replace(/less$/,"css")):(n.rel="stylesheet",n.href=e),(document.head||document.getElementsByTagName("head")[0]).appendChild(n),n},buildHash:function(e){var n,t="#!"+encodeURIComponent(e.id);for(n in e.args)t+=e.args[n]===undefined?"&"+encodeURIComponent(n):"&"+encodeURIComponent(n)+"="+encodeURIComponent(e.args[n]);return t},parseHash:function(e){var n,o,i,s={id:r,args:{}};if(e=e.substr(1).replace(/[#\?].*$/,""),i=e.match(/[^=&]+(=[^&]*)?/g)){"!"===i[0].charAt(0)&&(o=i[0].substr(1))in t&&(s.id=decodeURIComponent(o));for(n=1;i.length>n;n++)(o=i[n].match(/^([^=]+)(=)?(.+)?$/))&&(s.args[decodeURIComponent(o[1])]=o[2]?decodeURIComponent(o[3]||""):undefined)}return s},isSameLocation:function(e,n){var t;if(e.id===n.id&&Object.keys(e.args).length===Object.keys(n.args).length){for(t in e.args){if(!(t in n.args))return!1;if(e.args[t]===undefined){if(n.args[t]!==undefined)return!1}else if(""+e.args[t]!=""+n.args[t])return!1}return!0}return!1},replaceLocation:function(e){l.location&&l.isSameLocation(e,l.location)?l.reloadPage():location.replace(l.buildHash(e))}};return function(){function e(e,t){var o,i;for(e.xEvents[t.type].locked=!0,o=0;e.xEvents[t.type].length>o;o++)e.xEvents[t.type][o].call(e,t);for(e.xEvents[t.type].locked=!1;e.xEvents[t.type].stack.length;)e.xEvents[t.type].stack[0]?(i=e.xEvents[t.type].indexOf(e.xEvents[t.type].stack[0][1]),e.xEvents[t.type].stack[0][0]?0>i||e.xEvents[t.type].splice(i,1):0>i&&e.xEvents[t.type].push(e.xEvents[t.type].stack[0][1])):e.xEvents[t.type].splice(0,e.xEvents[t.type].length),e.xEvents[t.type].stack.shift();if(e.xEvents[t.type].length||(delete e.xEvents[t.type],e["on"+t.type]=null),e.xEvents.removeMark){delete e.xEvents.removeMark;for(o in e.xEvents)delete e.xEvents[n],e["on"+o]=null;delete e.xEvents}}l.listeners={add:function(n,t,o){n.xEvents||(n.xEvents=function(t){e(n,t)}),n.xEvents[t]||(n.xEvents[t]=[],n.xEvents[t].stack=[],n.xEvents[t].locked=!1,n["on"+t]=n.xEvents),n.xEvents[t].locked?n.xEvents[t].stack.push([!1,o]):0>n.xEvents[t].indexOf(o)&&n.xEvents[t].push(o)},list:function(e,n){var t,o;if(n)t=e.xEvents&&e.xEvents[n]?e.xEvents[n].slice(0):[];else if(t={},e.xEvents)for(o in e.xEvents)"array"===$.type(e.xEvents[o])&&e.xEvents[o].length&&(t[o]=e.xEvents[o].slice(0));return t},remove:function(e,n,t){var o,i,s;if(e.xEvents)if(n)e.xEvents[n]&&(e.xEvents[n].locked?e.xEvents[n].stack.push(t?[!0,t]:null):t?0>(s=e.xEvents[n].indexOf(t))||e.xEvents[n].splice(s,1):e.xEvents[n].splice(0,e.xEvents[n].length),0===e.xEvents[n].length&&(delete e.xEvents[n],e["on"+n]=null));else if(!e.xEvents.removeMark){for(o in e.xEvents)e.xEvents[o].locked?i=!0:(delete e.xEvents[o],e["on"+o]=null);i?e.xEvents.removeMark=!0:delete e.xEvents}}}}(),function(){function e(e,n){o=!0,$(r).animate({"margin-left":n?"-100%":"0%"},{duration:200,complete:function(){o=!1,e(),"function"==typeof a&&(a(),a=undefined)}})}function n(){"function"==typeof i[t].onunload&&i[t].onunload(),e(function(){"function"==typeof i[t].onunloadend&&i[t].onunloadend(),document.getElementById(t).style.display=d.style.display="",t=undefined},!1)}var t,o,a,d=document.getElementById("panels"),r=d.lastChild.firstChild;l.openPanel=function(e,n){var t=i[e];t?c("panel",t,e,function(){"function"==typeof t.open?t.open(n):l.showPanel(e,n)}):l.hint("panel config not found: "+e,"error")},l.showPanel=function(s,c){function r(){setTimeout(function(){a=function(){l.showPanel(s,c)}},0)}o?r():t?(n(),r()):("function"==typeof i[s].onload&&i[s].onload(c),d.className=t=s,d.style.display=document.getElementById(s).style.display="block",e(function(){"function"==typeof i[s].onloadend&&i[s].onloadend()},!0))},l.closePanel=function(e){var i;o?setTimeout(function(){a=function(){l.closePanel(e)}},0):t&&(i="string"==typeof e?e===t:"array"!==$.type(e)||e.indexOf(t)>=0,i?n():a&&(a=undefined))},l.destoryPanel=function(e){var n=i[e];n&&s(n,"panel",e)},$(d.firstChild).on("click",l.closePanel),$(r.firstChild).on("click",l.closePanel)}(),function(){var e,n=document.getElementById("popups");l.openPopup=function(e,n){var t=o[e];t?c("popup",t,e,function(){"function"==typeof t.open?t.open(n):l.showPopup(e,n)}):l.hint("popup config not found: "+e,"error")},l.showPopup=function(t,i){var s,c=o[t];e?("function"==typeof o[e].onunload&&o[e].onunload(),document.getElementById(e).style.display=""):(n.style.display="block",s=!0),e=t,n.className=t,document.getElementById(t).style.display="block",s&&"function"==typeof l.popupEvents.onshow&&l.popupEvents.onshow({type:"show"}),"function"==typeof c.onload&&c.onload(i)},l.closePopup=function(t){var i;if(e&&(i="string"==typeof t?t===e:"array"!==$.type(t)||t.indexOf(e)>=0))return"function"==typeof o[e].onunload&&o[e].onunload(),document.getElementById(e).style.display="",i=e,n.className=n.style.display=e="","function"==typeof l.popupEvents.onhide&&l.popupEvents.onhide({type:"hide",id:i}),!0},l.getCurrentPopup=function(){return e},l.destoryPopup=function(e){var n=o[e];n&&s(n,"popup",e)},l.popupEvents={},$("#popups>div>a").on("click",function(){l.closePopup()})}(),function(){function n(){i=$(window).innerWidth(),s=$(window).innerHeight(),"number"==typeof f.current&&h[f.current]&&o(f.current)}function t(e){f.children[e].one("load",function(){h[e]={w:this.width,h:this.height},y[e]=0,f.current===e&&o(e),this.style.visibility="visible"})}function o(e){var n,t,o,c,a,d=y[e]%2;d?(c=h[e].h,a=h[e].w):(c=h[e].w,a=h[e].h),c>i||a>s?(n=c/a,i/s>n?(o=s,t=o*n):(t=i,o=t/n),d?(c=o,a=t):(c=t,a=o),f.children[e].css("cursor","zoom-in")):(c=h[e].w,a=h[e].h,f.children[e].css("cursor","")),f.children[e].css({top:(s-a)/2+"px",left:(i-c)/2+"px",width:c+"px",height:a+"px",transform:"rotate("+90*y[e]+"deg)"})}var i,s,c=$("#photoview"),a=c.find(".close"),d=c.find(".prev"),r=c.find(".next"),u=c.find(".rotate.p"),p=c.find(".rotate.n"),f=e(c.find(">div")),h=[],y=[];l.showPhotoView=function(e,n){var o;if("array"===$.type(e)){for(o=0;e.length>o;o++)f.add($('<img src="'+e[o]+'"/>')),t(o);n>=0&&f.children.length>n&&f.slideTo(n,!0),f.children.length>1?(d.css("display","block"),r.css("display","block")):(d.css("display",""),r.css("display",""))}},l.hidePhotoView=function(){for(h=[];f.children.length;)f.remove(0)},c.on("click",">div>img",function(){var e;"zoom-in"===this.style.cursor?(e=y[f.current]%2,e?(this.style.top=h[f.current].w>s?(h[f.current].w-h[f.current].h)/2+"px":(s-h[f.current].h)/2+"px",this.style.left=h[f.current].h>i?(h[f.current].h-h[f.current].w)/2+"px":(i-h[f.current].w)/2+"px"):(this.style.top=h[f.current].h>s?0:(s-h[f.current].h)/2+"px",this.style.left=h[f.current].w>i?0:(i-h[f.current].w)/2+"px"),this.style.width=h[f.current].w+"px",this.style.height=h[f.current].h+"px",this.style.cursor="zoom-out"):"zoom-out"===this.style.cursor&&o(f.current)}),$(window).on("resize",n),d.on("click",function(){f.slideTo(f.current-1)}),r.on("click",function(){f.slideTo(f.current+1)}),u.on("click",function(){"number"==typeof y[f.current]&&(y[f.current]++,o(f.current))}),p.on("click",function(){"number"==typeof y[f.current]&&(y[f.current]--,o(f.current))}),a.on("click",l.hidePhotoView),f.onchange=function(){this.current===undefined?c.css("display",""):(h[this.current]&&o(this.current),c.css("display","block"))},"transform"in document.documentElement.style&&(u.css("display","block"),p.css("display","block")),n()}(),function(){var e,n,t,o=(document.getElementById("hintCtn"),0),i=document.getElementById("dialogs"),s=[];l.showLoading=function(e){$("#loading>div>div").text(e||"加载中..."),0===o&&(document.getElementById("loading").style.display="block"),o+=1},l.hideLoading=function(){o>0&&0===(o-=1)&&(document.getElementById("loading").style.display="","function"==typeof l.dialogEvents.onloaded&&l.dialogEvents.onloaded({type:"loaded"}))},l.isLoading=function(){return o>0},l.hint=function(n,t,o){var i=$("#hint");i.prop("className",t||""),i.find("span").text(n),e?clearTimeout(e):(i.css("display","block"),i.fadeIn()),o||(o="error"===t?4e3:"warning"===t?3e3:2e3),e=setTimeout(function(){e=0,i.fadeOut(function(){i.css("display","")})},o)},l.showReadable=function(e,n,o,i){var s=$("#readable");"string"==typeof e?s.find(">div").css("width",n).css("height",o).find(">div").html(e):s.find(">div").css("width",n).css("height",o).find(">div").append(e),s.css("display","block"),t=i},l.hideReadable=function(){"function"==typeof t&&(t(),t=undefined),$("#readable").css("display","").find(">div>div>*").remove()},l.hideDialog=function(e){var t;"function"==typeof n&&("isConfirm"===i.className?n(e):"isAlert"===i.className&&n(),n=undefined),i.className="",s.length>0&&(t=s[0][0],s[0].shift(),l[t].apply(this,s[0]),s.shift())},l.showForeign=function(e,n,t,o){l.showReadable('<iframe frameborder="no" allowtransparency="yes" marginwidth="0" marginheight="0" style="width:100%;height:100%;" src="'+e+'"></iframe>',n,t,o)},l.confirm=function(e,t,o,c){var a,d;""===i.className?(a=$(i).find(">div"),d=a.find(">div>div"),n=t,a.css("width",o||"400px"),d.text(e),i.className="isConfirm",a.css("height",d.outerHeight()+Math.max($(i).find(">div>a.yes").outerHeight(),$(i).find(">div>a.no").outerHeight())+76+"px")):s.push(["confirm",e,t,o,c])},l.alert=function(e,t,o){var c,a;""===i.className?(c=$(i).find(">div"),a=c.find(">div>div"),n=t,c.css("width",o||"400px"),a.text(e),i.className="isAlert",c.css("height",a.outerHeight()+46+"px")):s.push(["alert",e,t,o])},$("#readable>div>a").on("click",l.hideReadable),$(window).on("keydown",function(e){27===e.keyCode&&"block"===$("#readable").css("display")&&l.hideReadable()}),$(i).find(">div>a.close").on("click",l.hideDialog),$(i).find(">div>a.yes").on("click",function(){l.hideDialog(!0)}),$(i).find(">div>a.no").on("click",function(){l.hideDialog(!1)}),l.dialogEvents={}}(),function(){function e(){var e=l.parseHash(location.hash),s=history.state,a=e.id!==n;history.replaceState&&history.replaceState(!0,null),l.location&&l.isSameLocation(l.location,e)||(l.location=e,l.closePanel(),l.closePopup(),l.hideReadable(),"function"==typeof o&&o(a),c("page",t[e.id],e.id,function(){var o,c;a?(n?("function"==typeof t[n].onunload&&t[n].onunload(),document.getElementById(n).style.display="",o=!i&&!s):"autopopup"in e.args&&l.openPopup(e.args.autopopup,e.args.autopopuparg?JSON.parse(e.args.autopopuparg):undefined),document.body.className=n=e.id,document.getElementById(e.id).style.display="block","function"==typeof t[e.id].onload&&t[e.id].onload(!0),o?(c=Math.max(document.body.scrollTop,document.documentElement.scrollTop))>0&&$("html,body").animate({scrollTop:0},c):i&&(i.scrollTop=i.scrollLeft=0)):"function"==typeof t[e.id].onload&&t[e.id].onload()}))}var n,o,i;l.init=function(n,t,s){var c;r=n,i=t,o=s,"onhashchange"in window?$(window).on("hashchange",e):setInterval(function(){c!==location.hash&&(c=location.hash,e())},10),e()},l.setHome=function(n){var o;if(n in t&&(o=r,r=n,l.location&&l.location.id===o&&!l.isSameLocation(l.location,l.parseHash(location.hash))))return e(),!0},l.reloadPage=function(e){(!e||"string"==typeof e&&e===l.location.id||"array"===$.type(e)&&e.indexOf(l.location.id)>=0)&&(l.closePanel(),l.closePopup(),l.hideReadable(),"function"==typeof t[n].onunload&&t[n].onunload(),"function"==typeof t[n].onload&&t[n].onload(!0))},l.destoryPage=function(e){var n=t[e];n&&s(n,"page",e)}}(),l});